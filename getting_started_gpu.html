<!-- HTML header for doxygen 1.8.5-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.5"/>
<title>Intel(R) MKL-DNN: Getting Started with Intel(R) MKL-DNN with GPU support</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Intel(R) Math Kernel Library for Deep Neural Networks (Intel(R) MKL-DNN)
   &#160;<span id="projectnumber">0.90.0</span>
   </div>
   <div id="projectbrief">Performance library for Deep Learning</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.5 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(11)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(12)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Getting Started with Intel(R) MKL-DNN with GPU support </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This is an introduction to Intel MKL-DNN with GPU support. We are going to walk through a simple example to demonstrate OpenCL* extensions API in Intel MKL-DNN.</p>
<h2>Intel MKL-DNN basic workflow</h2>
<p>A very simple workflow in Intel MKL-DNN includes the following steps:</p>
<ul>
<li>Engine creation</li>
<li>Input/output memory objects creation<ul>
<li>Memory descriptors creation</li>
<li>Memory objects creation</li>
</ul>
</li>
<li>Operation primitive creation<ul>
<li>Operation descriptor creation</li>
<li>Operation primitive descriptor creation</li>
<li>Primitive creation</li>
</ul>
</li>
<li>Stream object creation</li>
<li>Primitive submission for execution to a stream</li>
</ul>
<h2>Create engine and memory object</h2>
<p>Let's create a GPU engine object. The second parameter specifies the index of the requested engine.</p>
<div class="fragment"><div class="line"><span class="keyword">auto</span> eng = <a class="code" href="group__cpp__api__enums.html#gga6d88ff11a07bae09a5c348d314c5d1d9aad1943a9fd6d3d7ee1e6af41a5b0d3e7">engine</a>(engine::kind::gpu, 0);</div>
</div><!-- fragment --><p>Then, we create a memory object. We need to specify dimensions of our memory by passing <code>memory::dims</code> object. Then we create a memory descriptor with these dimensions, with <code>f32</code> data type and <code>nchw</code> memory format. Finally, we construct a memory object and pass the memory descriptor. The library allocates memory internally.</p>
<div class="fragment"><div class="line"><span class="keyword">auto</span> tz_dims = memory::dims{2, 3, 4, 5};</div>
<div class="line">memory::desc mem_d(tz_dims, memory::data_type::f32, memory::format_tag::nchw);</div>
<div class="line">memory mem(mem_d, eng);</div>
</div><!-- fragment --><h2>Initialize the data executing a custom OpenCL kernel</h2>
<p>We are going to create an OpenCL kernel that will initialize our data. It requries writing a bit of C code to create an OpenCL program from a string literal source, build it and extract the kernel. The kernel initializes the data by the <code>0, -1, 2, -3, ...</code> sequence: <code>data[i] = (-1)^i * i</code>.</p>
<div class="fragment"><div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> *ocl_code</div>
<div class="line">        = <span class="stringliteral">&quot;__kernel void init(__global float *data) {&quot;</span></div>
<div class="line">          <span class="stringliteral">&quot;    int id = get_global_id(0);&quot;</span></div>
<div class="line">          <span class="stringliteral">&quot;    data[id] = (id % 2) ? -id : id;&quot;</span></div>
<div class="line">          <span class="stringliteral">&quot;}&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> *kernel_name = <span class="stringliteral">&quot;init&quot;</span>;</div>
<div class="line">cl_kernel ocl_init_kernel = create_init_opencl_kernel(</div>
<div class="line">        eng.get_ocl_context(), kernel_name, ocl_code);</div>
</div><!-- fragment --><p>Refer to the full code example for the code of <code>create_init_opencl_kernel()</code> function. The next step is to execute our OpenCL kernel: set its arguments and enqueue to an OpenCL queue. The underlying OpenCL buffer can be extracted from the memory object using the interoperability interface: <code>memory::get_ocl_mem_object()</code>. For simplicity we can just construct a stream, extract the underlying OpenCL queue and enqueue the kernel to this queue:</p>
<div class="fragment"><div class="line">cl_mem ocl_buf = mem.get_ocl_mem_object();</div>
<div class="line">clSetKernelArg(ocl_init_kernel, 0, <span class="keyword">sizeof</span>(ocl_buf), &amp;ocl_buf);</div>
<div class="line"></div>
<div class="line"><a class="code" href="structmkldnn_1_1stream.html">mkldnn::stream</a> strm(eng);</div>
<div class="line">cl_command_queue ocl_queue = strm.get_ocl_command_queue();</div>
<div class="line">clEnqueueNDRangeKernel(ocl_queue, ocl_init_kernel, 1, <span class="keyword">nullptr</span>, &amp;N, <span class="keyword">nullptr</span>, 0,</div>
<div class="line">                       <span class="keyword">nullptr</span>, <span class="keyword">nullptr</span>);</div>
</div><!-- fragment --><h2>Create and execute a primitive</h2>
<p>There are 3 steps to create an operation primitive in Intel MKL-DNN:</p>
<ul>
<li>Create an operation descriptor</li>
<li>Create a primitive descriptor</li>
<li>Create a primitive</li>
</ul>
<p>Let's create the primitive to perform ReLU (recitified linear unit) operation: <code>x = max(0, x)</code>.</p>
<div class="fragment"><div class="line"><span class="keyword">auto</span> relu_d = eltwise_forward::desc(prop_kind::forward, algorithm::eltwise_relu,</div>
<div class="line">                                    mem_d, 0.0f);</div>
<div class="line"><span class="keyword">auto</span> relu_pd = eltwise_forward::primitive_desc(relu_d, eng);</div>
<div class="line"><span class="keyword">auto</span> relu = eltwise_forward(relu_pd);</div>
</div><!-- fragment --><p>From the code above we see that an operation descriptor has no dependency on a specific engine - it just describes some operation. On the contrary, primitive descriptors are attached to a specific engine and represent some implementation for this engine. A primitive object is realization of a primitive descriptor and its construction is usually much "heavier".</p>
<p>Note that for our primitive <code>mem</code> serves as both input and output parameter.</p>
<p>Next, execute the primitive:</p>
<div class="fragment"><div class="line">relu.execute(strm, { { <a class="code" href="group__c__api__types__arguments.html#gaf227e0edc89d4166e5ce0ffb032a820b">MKLDNN_ARG_SRC</a>, mem }, { <a class="code" href="group__c__api__types__arguments.html#gacb06afbc46f0663ec7fa06e2f67477ba">MKLDNN_ARG_DST</a>, mem } });</div>
</div><!-- fragment --><p>Note, primitive submission on GPU is asynchronous. But user can call <code>stream::wait()</code> to synchronize the stream and ensure that all previously submitted primitives are completed.</p>
<h2>Validating the results</h2>
<p>The simplest way to access the OpenCL memory is to map it to the host using <code>memory::map_data()</code> and <code>memory::unmap_data()</code> APIs. After mapping this data is directly accessible (reading/writing) on the host. Whlie the data is mapped, any GPU-side operations on this data are not allowed. The data should be unmapped to release all resources associated with mapping.</p>
<div class="fragment"><div class="line"><span class="keywordtype">float</span> *mapped_data = mem.map_data&lt;<span class="keywordtype">float</span>&gt;();</div>
<div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i &lt; N; i++) {</div>
<div class="line">    <span class="keywordtype">float</span> expected = (i % 2) ? 0.0f : (<span class="keywordtype">float</span>)i;</div>
<div class="line">    assert(mapped_data[i] == expected);</div>
<div class="line">}</div>
<div class="line">mem.unmap_data(mapped_data);</div>
</div><!-- fragment --> <hr/>
<p>The full code example is listed below:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;CL/cl.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="mkldnn_8hpp.html">mkldnn.hpp</a>&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;cassert&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;numeric&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">using namespace </span>mkldnn;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define OCL_CHECK(x)                                                      \</span></div>
<div class="line"><span class="preprocessor">    do {                                                                  \</span></div>
<div class="line"><span class="preprocessor">        cl_int s = (x);                                                   \</span></div>
<div class="line"><span class="preprocessor">        if (s != CL_SUCCESS) {                                            \</span></div>
<div class="line"><span class="preprocessor">            printf(&quot;OpenCL error: %d at %s:%d\n&quot;, s, __FILE__, __LINE__); \</span></div>
<div class="line"><span class="preprocessor">            exit(1);                                                      \</span></div>
<div class="line"><span class="preprocessor">        }                                                                 \</span></div>
<div class="line"><span class="preprocessor">    } while (0)</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">cl_kernel create_init_opencl_kernel(</div>
<div class="line">        cl_context ocl_ctx, <span class="keyword">const</span> <span class="keywordtype">char</span> *kernel_name, <span class="keyword">const</span> <span class="keywordtype">char</span> *ocl_code) {</div>
<div class="line">    cl_int err;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *sources[] = { ocl_code };</div>
<div class="line">    cl_program ocl_program</div>
<div class="line">            = clCreateProgramWithSource(ocl_ctx, 1, sources, <span class="keyword">nullptr</span>, &amp;err);</div>
<div class="line">    OCL_CHECK(err);</div>
<div class="line"></div>
<div class="line">    OCL_CHECK(</div>
<div class="line">            clBuildProgram(ocl_program, 0, <span class="keyword">nullptr</span>, <span class="keyword">nullptr</span>, <span class="keyword">nullptr</span>, <span class="keyword">nullptr</span>));</div>
<div class="line"></div>
<div class="line">    cl_kernel ocl_kernel = clCreateKernel(ocl_program, kernel_name, &amp;err);</div>
<div class="line">    OCL_CHECK(err);</div>
<div class="line"></div>
<div class="line">    OCL_CHECK(clReleaseProgram(ocl_program));</div>
<div class="line">    <span class="keywordflow">return</span> ocl_kernel;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span> main() {</div>
<div class="line">    <a class="code" href="structmkldnn_1_1memory.html#a4b929aee34491e5140d055a9e1daf180">memory::dims</a> tz_dims = { 2, 3, 4, 5 };</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">size_t</span> N = std::accumulate(tz_dims.begin(), tz_dims.end(), (size_t)1,</div>
<div class="line">            std::multiplies&lt;size_t&gt;());</div>
<div class="line"></div>
<div class="line">    <a class="code" href="structmkldnn_1_1memory_1_1desc.html">memory::desc</a> mem_d(tz_dims, <a class="code" href="structmkldnn_1_1memory.html#aa8a0d49cc7faaceef9d8f55d66bff57ba512dc597be7ae761876315165dc8bd2e">memory::data_type::f32</a>,</div>
<div class="line">            <a class="code" href="structmkldnn_1_1memory.html#a123930e31c5460c2c5f052a59c2a4cedaded7ac40158367123c5467281d44cbeb">memory::format_tag::nchw</a>);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="structmkldnn_1_1engine.html">engine</a> eng(<a class="code" href="structmkldnn_1_1engine.html#a81bcf1ea92d7f98852a2c3e187825de6a0aa0be2a866411d9ff03515227454947">engine::kind::gpu</a>, 0);</div>
<div class="line">    <a class="code" href="structmkldnn_1_1memory.html">memory</a> mem(mem_d, eng);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Extract OpenCL buffer from memory object</span></div>
<div class="line">    cl_mem ocl_buf = mem.get_ocl_mem_object();</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Create stream</span></div>
<div class="line">    <a class="code" href="structmkldnn_1_1stream.html">mkldnn::stream</a> strm(eng);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Create custom OpenCL kernel to initialize the data</span></div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *ocl_code</div>
<div class="line">            = <span class="stringliteral">&quot;__kernel void init(__global float *data) {&quot;</span></div>
<div class="line">              <span class="stringliteral">&quot;    int id = get_global_id(0);&quot;</span></div>
<div class="line">              <span class="stringliteral">&quot;    data[id] = (id % 2) ? -id : id;&quot;</span></div>
<div class="line">              <span class="stringliteral">&quot;}&quot;</span>;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *kernel_name = <span class="stringliteral">&quot;init&quot;</span>;</div>
<div class="line">    cl_kernel ocl_init_kernel = create_init_opencl_kernel(</div>
<div class="line">            eng.get_ocl_context(), kernel_name, ocl_code);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Execute the custom OpenCL kernel</span></div>
<div class="line">    OCL_CHECK(clSetKernelArg(ocl_init_kernel, 0, <span class="keyword">sizeof</span>(ocl_buf), &amp;ocl_buf));</div>
<div class="line"></div>
<div class="line">    cl_command_queue ocl_queue = strm.get_ocl_command_queue();</div>
<div class="line">    OCL_CHECK(clEnqueueNDRangeKernel(ocl_queue, ocl_init_kernel, 1, <span class="keyword">nullptr</span>, &amp;N,</div>
<div class="line">            <span class="keyword">nullptr</span>, 0, <span class="keyword">nullptr</span>, <span class="keyword">nullptr</span>));</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Perform ReLU operation by executing the primitive</span></div>
<div class="line">    <span class="keyword">auto</span> relu_d = <a class="code" href="structmkldnn_1_1eltwise__forward_1_1desc.html">eltwise_forward::desc</a>(<a class="code" href="group__cpp__api__enums.html#ggaeb087eae78f70a4d249a90aefa165cf8a965dbaac085fc891bfbbd4f9d145bbc8">prop_kind::forward</a>,</div>
<div class="line">            <a class="code" href="group__cpp__api__enums.html#ggae45a07d6121fdd33e310782753178076aba09bebb742494255b90b43871c01c69">algorithm::eltwise_relu</a>, mem_d, 0.0f);</div>
<div class="line">    <span class="keyword">auto</span> relu_pd = <a class="code" href="structmkldnn_1_1eltwise__forward_1_1primitive__desc.html">eltwise_forward::primitive_desc</a>(relu_d, eng);</div>
<div class="line">    <span class="keyword">auto</span> relu = <a class="code" href="structmkldnn_1_1eltwise__forward.html">eltwise_forward</a>(relu_pd);</div>
<div class="line">    relu.execute(strm, { { <a class="code" href="group__c__api__types__arguments.html#gaf227e0edc89d4166e5ce0ffb032a820b">MKLDNN_ARG_SRC</a>, mem }, { <a class="code" href="group__c__api__types__arguments.html#gacb06afbc46f0663ec7fa06e2f67477ba">MKLDNN_ARG_DST</a>, mem } });</div>
<div class="line">    strm.wait();</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Map the data to the host to validate the results</span></div>
<div class="line">    <span class="keywordtype">float</span> *mapped_data = mem.map_data&lt;<span class="keywordtype">float</span>&gt;();</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i &lt; N; i++) {</div>
<div class="line">        <span class="keywordtype">float</span> expected = (i % 2) ? 0.0f : (<span class="keywordtype">float</span>)i;</div>
<div class="line">        assert(mapped_data[i] == expected);</div>
<div class="line">    }</div>
<div class="line">    mem.unmap_data(mapped_data);</div>
<div class="line"></div>
<div class="line">    OCL_CHECK(clReleaseKernel(ocl_init_kernel));</div>
<div class="line"></div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;PASSED&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --> <hr/>
<p><a class="el" href="legal_information.html">Legal information</a> </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.5
</small></address>
</body>
</html>
